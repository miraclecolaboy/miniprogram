<!-- packages/admin/pages/goods/index.wxml -->
<view class="page">
  <!-- [新增] 隐藏的 Canvas, 用于图片裁剪 -->
  <canvas
    canvas-id="image-cropper"
    id="image-cropper"
    style="position: fixed; left: -9999px; top: -9999px; width: 300px; height: 300px;"
  ></canvas>

  <view class="page-header">
    <view class="top-card">
      <view class="row-between">
        <view>
          <view class="title">商品管理</view>
          <view class="sub">统一管理商品 分类 规格 库存等信息</view>
        </view>
        <view class="btn btn-primary" bindtap="openAdd">新增商品</view>
      </view>

      <view class="filter-row">
        <input class="input" placeholder="搜索商品名" value="{{keyword}}" bindinput="onKeywordInput" />
        <picker class="picker picker-inline" mode="selector" range="{{categories}}" range-key="name" value="{{filterCategoryIndex}}" bindchange="onFilterCategoryChange">
          <view class="picker-view">
            <text class="picker-text">{{categories[filterCategoryIndex].name || '全部分类'}}</text>
            <text class="picker-arrow">›</text>
          </view>
        </picker>
        <view class="btn" bindtap="openCategoryForm">新增分组</view>
      </view>
    </view>
  </view>

  <view class="page-body">
    <scroll-view class="listScroll" scroll-y="true" enhanced="true" enable-back-to-top="true" wx:if="{{!showForm}}">
      <!-- [修改] 列表项图片使用 thumbUrl -->
      <view class="card" wx:for="{{list}}" wx:key="_id">
        <view class="row-between">
          <view class="item-left">
            <view class="row">
              <view class="thumb" wx:if="{{item.thumbUrl}}">
                <image class="thumb-img" mode="aspectFill" src="{{item.thumbUrl}}" />
              </view>
              <view class="info">
                <view class="item-title">{{item.name}}</view>
                <view class="item-sub">
                  <text>¥{{item.price}}</text>
                  <text style="margin-left: 16rpx;">{{(item.hasSpecs) ? '总库存' : '库存'}} {{item.stock}}</text>
                  <text style="margin-left: 16rpx;">{{item.status===1 ? '上架' : '下架'}}</text>
                </view>
                <view class="item-sub">
                  <text>分类：{{item.categoryName || '-'}}</text>
                </view>
                <view class="item-sub" wx:if="{{item.hasSpecs}}">
                  <text>规格：{{item.specsCountText}}</text>
                </view>
              </view>
            </view>
          </view>
          <view class="item-actions">
            <view class="btn btn-mini" data-id="{{item._id}}" data-onshelf="{{item.status===1}}" bindtap="toggleShelf">
              {{item.status===1 ? '下架' : '上架'}}
            </view>
            <view class="btn btn-mini" data-id="{{item._id}}" bindtap="openEdit">编辑</view>
            <view class="btn btn-danger btn-mini" data-id="{{item._id}}" bindtap="removeItem">删除</view>
          </view>
        </view>
      </view>
      <view class="footer-tip" wx:if="{{loading}}">加载中...</view>
      <view class="footer-tip" wx:if="{{!loading && list.length===0}}">暂无商品</view>
      <view class="footer-tip" wx:if="{{!loading && !hasMore && list.length>0}}">没有更多了</view>
    </scroll-view>
  </view>

  <!-- 表单弹层 -->
  <view class="formMask" wx:if="{{showForm}}" catchtouchmove="true">
    <view class="formBg" bindtap="cancelForm"></view>
    <view class="formWrap" catchtap="noop">
      <scroll-view class="formScroll" scroll-y="true" enable-back-to-top="true">
        <view class="card formCard">
          <view class="row-between">
            <view class="title">{{editingId ? '编辑商品' : '新增商品'}}</view>
            <view class="btn" bindtap="cancelForm">关闭</view>
          </view>
          <view class="form">
            <view class="section-title">基础信息</view>
            <view class="field">
              <view class="label">商品名</view>
              <input class="input" placeholder="例如：招牌面包" value="{{form.name}}" bindinput="onFormInput" data-field="name" />
            </view>
            <view class="field">
              <view class="label">商品分类</view>
              <picker class="picker picker-full" mode="selector" range="{{categories}}" range-key="name" value="{{formCategoryIndex}}" bindchange="onFormCategoryChange">
                <view class="picker-view">
                  <text class="picker-text">{{categories[formCategoryIndex].name || '请选择分类'}}</text>
                  <text class="picker-arrow">›</text>
                </view>
              </picker>
            </view>
            <view class="field-row">
              <view class="field half">
                <view class="label">{{form.hasSpecs ? '展示价格' : '价格'}}</view>
                <input class="input" type="digit" value="{{form.price}}" bindinput="onFormInput" data-field="price" disabled="{{form.hasSpecs}}" />
                <view wx:if="{{form.hasSpecs}}" class="hint">由SKU最低价自动计算</view>
              </view>
              <view class="field half">
                <view class="label">{{form.hasSpecs ? '总库存' : '库存'}}</view>
                <input class="input" type="number" value="{{form.stock}}" bindinput="onFormInput" data-field="stock" disabled="{{form.hasSpecs}}" />
                <view wx:if="{{form.hasSpecs}}" class="hint">由SKU库存总和自动计算</view>
              </view>
            </view>
            <view class="field-row">
              <view class="field half">
                <view class="label">排序</view>
                <input class="input" type="number" value="{{form.sort}}" bindinput="onFormInput" data-field="sort" />
              </view>
              <view class="field half">
                <view class="label">上架状态</view>
                <switch checked="{{form.onShelf}}" bindchange="onShelfSwitch" />
              </view>
            </view>
            <view class="field">
              <view class="label">售卖模式</view>
              <view class="pill-group">
                <view class="pill {{formModesMap.ziti ? 'pill-on' : ''}}" data-mode="ziti" bindtap="toggleMode">到店</view>
                <view class="pill {{formModesMap.waimai ? 'pill-on' : ''}}" data-mode="waimai" bindtap="toggleMode">外卖</view>
                <view class="pill {{formModesMap.kuaidi ? 'pill-on' : ''}}" data-mode="kuaidi" bindtap="toggleMode">快递</view>
              </view>
            </view>
            <view class="section-title">规格与描述</view>
            <view class="field">
              <view class="label">商品图片 (最多3张，第一张为主图)</view>
              <!-- [修改] 循环新的 displayImages 数组 -->
              <view class="img-grid">
                <view class="img-box" wx:for="{{form.displayImages}}" wx:key="key" bindtap="previewImage" data-index="{{index}}">
                  <image class="img" mode="aspectFill" src="{{item.preview}}" />
                  <view class="img-remove" catchtap="removeImage" data-index="{{index}}">×</view>
                </view>
                <view class="img-box img-box-add" wx:if="{{form.displayImages.length < 3}}" bindtap="chooseImage">
                  <text class="img-add-plus">+</text>
                  <text class="img-add-sub">{{form.displayImages.length}}/3</text>
                </view>
              </view>
            </view>
            <view class="field">
              <view class="label">简短描述</view>
              <input class="input" placeholder="例如：醇香浓郁，回购率高" value="{{form.desc}}" bindinput="onFormInput" data-field="desc" />
            </view>
            <view class="field">
              <view class="label">详情</view>
              <textarea class="textarea" placeholder="例如：配料/口感/注意事项..." value="{{form.detail}}" bindinput="onFormInput" data-field="detail" />
            </view>
            <view class="field">
              <view class="row-between">
                <view class="label">启用规格</view>
                <switch checked="{{form.hasSpecs}}" bindchange="onHasSpecsSwitch" />
              </view>
            </view>
            <view class="spec-box" wx:if="{{form.hasSpecs}}">
              <view class="row-between">
                <view class="label">规格组</view>
                <view class="btn" bindtap="addSpecGroup">新增规格组</view>
              </view>
              <view class="spec-group" wx:for="{{form.specs}}" wx:for-item="g" wx:for-index="gi" wx:key="__g">
                <view class="row-between">
                  <input class="input" placeholder="规格组名：如 尺寸" value="{{g.name}}" bindinput="onSpecGroupNameInput" data-gi="{{gi}}" />
                  <view class="btn btn-danger" data-gi="{{gi}}" bindtap="removeSpecGroup">删除组</view>
                </view>
                <view class="spec-options">
                  <view class="spec-option" wx:for="{{g.options}}" wx:for-item="o" wx:for-index="oi" wx:key="__o">
                    <input class="input small" placeholder="选项：如 大杯" value="{{o.label}}" bindinput="onSpecOptionInput" data-gi="{{gi}}" data-oi="{{oi}}"/>
                    <view class="btn btn-danger btn-mini" data-gi="{{gi}}" data-oi="{{oi}}" bindtap="removeSpecOption">删除</view>
                  </view>
                  <view class="row" style="margin-top: 16rpx;">
                    <view class="btn btn-mini" data-gi="{{gi}}" bindtap="addSpecOption">新增选项</view>
                  </view>
                </view>
              </view>
              <view class="row-between" style="margin-top: 12rpx;">
                <view class="hint">修改规格后，请管理SKU</view>
                <view class="btn btn-primary btn-mini {{!editingId ? 'btn-disabled' : ''}}" bindtap="openSkuModal">管理SKU</view>
              </view>
            </view>
            <view class="row-between" style="margin-top: 22rpx;">
              <view class="btn" bindtap="cancelForm">取消</view>
              <view class="btn btn-primary {{saving ? 'btn-disabled' : ''}}" bindtap="saveForm">{{saving ? '保存中...' : '保存'}}</view>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- SKU库存弹层 -->
  <view class="formMask" wx:if="{{showSkuModal}}" catchtouchmove="true">
    <view class="formBg" bindtap="closeSkuModal"></view>
    <view class="formWrap" catchtap="noop">
      <scroll-view class="formScroll" scroll-y="true" enable-back-to-top="true">
        <view class="card formCard">
          <view class="row-between">
            <view class="title">SKU库存与价格</view>
            <view class="btn" bindtap="closeSkuModal">关闭</view>
          </view>
          <view class="field">
            <view class="label">批量填充(仅空值)</view>
            <view class="row-between">
              <input class="input" placeholder="价格" type="digit" value="{{skuBulkPrice}}" bindinput="onSkuBulkInput" data-field="Price" />
              <input class="input" placeholder="库存" type="number" value="{{skuBulkStock}}" bindinput="onSkuBulkInput" data-field="Stock" />
              <view class="btn btn-primary btn-mini" bindtap="applySkuBulk" data-field="price">填价格</view>
              <view class="btn btn-primary btn-mini" bindtap="applySkuBulk" data-field="stock">填库存</view>
            </view>
          </view>
          <view class="sku-list">
            <view class="sku-item sku-item-header">
              <view class="sku-text">规格</view>
              <view class="input sku-price-header">价格(元)</view>
              <view class="input sku-stock-header">库存</view>
            </view>
            <view class="sku-item" wx:for="{{skuItems}}" wx:for-item="s" wx:for-index="si" wx:key="skuKey">
              <view class="sku-text">{{s.specText}}</view>
              <input class="input sku-price" placeholder="售价" type="digit" value="{{s.price}}" data-index="{{si}}" bindinput="onSkuPriceInput" />
              <input class="input sku-stock" placeholder="0" type="number" value="{{s.stock}}" data-index="{{si}}" bindinput="onSkuStockInput" />
            </view>
          </view>
          <view class="row-between" style="margin-top: 22rpx;">
            <view class="btn" bindtap="closeSkuModal">取消</view>
            <view class="btn btn-primary {{skuSaving ? 'btn-disabled' : ''}}" bindtap="saveSkuStocks">{{skuSaving ? '保存中...' : '保存'}}</view>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- 新增分组弹窗 -->
  <view wx:if="{{showCategoryForm}}">
    <view class="mask" bindtap="closeCategoryForm"></view>
    <view class="modal" catchtap="noop">
      <view class="modal-card">
        <view class="row-between">
          <view class="title">新增分组</view>
          <view class="btn btn-mini" bindtap="closeCategoryForm">关闭</view>
        </view>

        <view class="field" style="margin-top: 16rpx;">
          <view class="label">分组名称</view>
          <input class="input" placeholder="例如：饮品" value="{{categoryForm.name}}" bindinput="onCategoryInput" data-field="name" />
        </view>

        <view class="field">
          <view class="label">排序</view>
          <input class="input" placeholder="0" type="number" value="{{categoryForm.sort}}" bindinput="onCategoryInput" data-field="sort" />
        </view>

        <view class="row-between" style="margin-top: 18rpx;">
          <view class="btn" bindtap="closeCategoryForm">取消</view>
          <view class="btn btn-primary {{categorySaving ? 'btn-disabled' : ''}}" bindtap="saveCategory">
            {{categorySaving ? '保存中...' : '保存'}}
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
<admin-tabbar />
