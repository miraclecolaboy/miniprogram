<view class="page">
  <scroll-view class="main-scroll" scroll-y="true" enhanced="true" enable-back-to-top="true" show-scrollbar="{{false}}">

    <view class="page-header row-between">
      <view class="header-left">
        <view class="page-title">数据统计</view>
        <!-- <view class="page-sub">按标签查看充值用户和订单数据</view> -->
      </view>
      <view class="btn btn-outline btn-mini {{loading ? 'btn-disabled' : ''}}" bindtap="onReloadTap">
        {{loading ? '加载中...' : '刷新数据'}}
      </view>
    </view>

    <view class="page-content">
      <view class="error-row" wx:if="{{errorText}}">{{errorText}}</view>

      <view class="filter-section">
        <view class="tabs-pill">
          <view
            wx:for="{{tabOptions}}"
            wx:key="key"
            class="tab-pill-item {{activeTab === item.key ? 'active' : ''}}"
            data-key="{{item.key}}"
            bindtap="onTabTap"
          >
            {{item.label}}
          </view>
        </view>
      </view>

      <view class="empty-hint" wx:if="{{loading && !hasData}}">数据加载中...</view>

      <block wx:if="{{hasData}}">
        <block wx:if="{{activeTab === 'store'}}">
          <view class="section-title">店铺数据</view>
          <view class="metrics-grid">
            <view class="metric-card" wx:for="{{customerCards}}" wx:key="label">
              <view class="metric-label">{{item.label}}</view>
              <view class="metric-value">{{item.value}}</view>
            </view>
          </view>
        </block>

        <block wx:elif="{{activeTab === 'recharge'}}">
          <view class="section-title">充值用户</view>
          <view class="meta-inline" wx:if="{{rechargeSummaryText}}">{{rechargeSummaryText}}</view>

          <view class="search-row">
            <input
              class="search-input"
              type="text"
              value="{{rechargeSearchKeyword}}"
              placeholder="通过用户名或电话搜索"
              bindinput="onRechargeSearchInput"
              confirm-type="search"
            />
          </view>

          <view class="card" wx:if="{{!rechargeUsers.length}}">
            <view class="empty-hint" style="padding: 20rpx 0;">暂无充值用户</view>
          </view>

          <view class="card recharge-card" wx:for="{{rechargeUsers}}" wx:key="openid">
            <view class="row-between">
              <view>
                <view class="recharge-name">{{item.userName}}</view>
                <view class="recharge-phone">电话：{{item.phone}}</view>
              </view>
              <view class="level-tag">{{item.memberLevelText}}</view>
            </view>

            <view class="recharge-metrics">
              <view class="metric-col">
                <view class="metric-col-label">累计充值</view>
                <view class="metric-col-value">{{item.totalRechargeText}}</view>
              </view>
              <view class="metric-col">
                <view class="metric-col-label">余额</view>
                <view class="metric-col-balance-row">
                  <view class="metric-col-value">{{item.balanceText}}</view>
                  <view
                    class="balance-log-btn"
                    data-openid="{{item.openid}}"
                    data-name="{{item.userName}}"
                    bindtap="onBalanceQueryTap"
                  >
                    查询余额流水
                  </view>
                </view>
              </view>
            </view>
          </view>
        </block>

        <block wx:else>
          <view class="section-title">订单数据</view>

          <view class="order-filter">
            <view class="tabs-pill order-time-tabs">
              <view
                wx:for="{{orderTimeOptions}}"
                wx:key="key"
                class="tab-pill-item {{orderTimeType === item.key ? 'active' : ''}}"
                data-key="{{item.key}}"
                bindtap="onOrderTimeTap"
              >
                {{item.label}}
              </view>
            </view>

            <view class="date-row" wx:if="{{orderDateText}}">统计区间：{{orderDateText}}</view>

            <view class="custom-range" wx:if="{{orderTimeType === 'custom'}}">
              <picker mode="date" value="{{customStartDate}}" bindchange="onCustomStartChange">
                <view class="date-picker">{{customStartDate || '开始日期'}}</view>
              </picker>
              <text class="date-sep">至</text>
              <picker mode="date" value="{{customEndDate}}" bindchange="onCustomEndChange">
                <view class="date-picker">{{customEndDate || '结束日期'}}</view>
              </picker>
              <view class="btn btn-primary btn-mini" bindtap="onApplyCustomRange">查询</view>
            </view>
          </view>

          <view class="metrics-grid">
            <view class="metric-card" wx:for="{{orderCards}}" wx:key="label">
              <view class="metric-label">{{item.label}}</view>
              <view class="metric-value">{{item.value}}</view>
            </view>
          </view>
        </block>

        <view class="remark-block" wx:if="{{tips.length}}">
          <text class="remark-label">统计说明：</text>
          <view style="flex:1;">
            <view class="remark-text" wx:for="{{tips}}" wx:key="*this">{{item}}</view>
          </view>
        </view>
      </block>

      <view style="height: 180rpx;"></view>
    </view>
  </scroll-view>

  <view class="popup-mask" wx:if="{{balancePopupVisible}}" catchtouchmove="onPopupTouchMove" bindtap="onBalancePopupClose">
    <view class="popup-panel" catchtap="onPopupInnerTap">
      <view class="popup-header row-between">
        <view>
          <view class="popup-title">{{balancePopupTitle}}</view>
          <view class="popup-sub" wx:if="{{balancePopupMeta}}">{{balancePopupMeta}}</view>
        </view>
        <view class="popup-close" bindtap="onBalancePopupClose">关闭</view>
      </view>

      <view class="empty-hint" wx:if="{{balancePopupLoading}}" style="padding: 36rpx 0;">加载中...</view>
      <view class="empty-hint" wx:if="{{!balancePopupLoading && !balanceLogs.length}}" style="padding: 36rpx 0;">暂无余额流水</view>

      <scroll-view class="popup-list" scroll-y="true" wx:if="{{!balancePopupLoading && balanceLogs.length}}">
        <view class="popup-item" wx:for="{{balanceLogs}}" wx:key="id">
          <view class="row-between">
            <view class="popup-scene">{{item.scene}}</view>
            <view class="popup-delta {{item.deltaClass}}">{{item.deltaText}}</view>
          </view>
          <view class="popup-remark" wx:if="{{item.remark}}">{{item.remark}}</view>
          <view class="popup-time">{{item.timeText || '-'}}</view>
        </view>
      </scroll-view>
    </view>
  </view>

  <admin-tabbar />
</view>
