<!-- packages/admin/pages/orders/index.wxml -->
<view class="page" bindtap="onScreenTap">

<view class="tabs">
  <view class="tabRow">
    <view
      wx:for="{{tabs}}"
      wx:key="key"
      class="tabItem {{activeTab===item.key?'tabActive':''}}"
      data-key="{{item.key}}"
      bindtap="onTabTap"
    >{{item.title}}</view>
  </view>
</view>


<view class="list">
  <view wx:for="{{list}}" wx:key="_id" class="card">
    <view class="row">
      <view class="title">{{item.modeText}}订单</view>
      <view class="status">{{item.statusView}}</view>
    </view>

    <view class="sub">下单：{{item.createdAtText}}</view>
    <view class="sub">订单号：{{item.orderNo}}</view>
    <view class="sub" wx:if="{{item.buyerNickName}}">用户：{{item.buyerNickName}}</view>
    <view class="sub price-row">
      <text class="price-main">实付：¥{{item.payAmountText}}</text>
      <text class="price-detail">（商品{{item.amountGoodsText}} + 运费{{item.amountDeliveryText}} - 会员{{item.amountVipDiscountText}} - 优惠券{{item.amountCouponDiscountText}}）</text>
    </view>
    <view wx:if="{{item.mode==='ziti' && item.pickupCodeText}}" class="sub">取餐号：{{item.pickupCodeText}}</view>
    <view wx:if="{{item.mode==='ziti' && item.pickupTimeText}}" class="sub">取餐时间：{{item.pickupTimeText}}</view>
    <view wx:if="{{item.mode==='ziti' && item.receiverPhone}}" class="sub">预留电话：{{item.receiverPhoneMasked}}</view>

    <view wx:if="{{item.mode!=='ziti'}}" class="addrBlock">
      <view class="sub">收货人：{{item.receiverName}}（{{item.receiverPhoneMasked}}）</view>
      <view class="sub">地址：{{item.addrText}}</view>
      <view wx:if="{{item.mode==='kuaidi' && item.expressNoText}}" class="sub">快递单号：{{item.expressNoText}}</view>

      <view class="btnRow">
        <button size="mini" class="btn" data-copytext="{{item.addrCopyText}}" bindtap="onCopyAddress">复制地址</button>
        <button wx:if="{{item.receiverPhone}}" size="mini" class="btn" data-phone="{{item.receiverPhone}}" bindtap="onCopyPhone">复制电话</button>

        <!-- [修正] 绑定 onOpenExpressModal -->
        <button
          wx:if="{{item.mode==='kuaidi'}}"
          size="mini"
          class="btn"
          data-id="{{item._id}}"
          data-no="{{item.expressNoText||''}}"
          bindtap="onOpenExpressModal"
        >快递单号</button>
      </view>
    </view>

    <view class="goods">
      <view class="sub">商品：</view>
      <view wx:for="{{item.itemsView}}" wx:for-item="g" wx:key="key" class="goodsLine">{{g.line}}</view>
    </view>

    <view wx:if="{{item.remarkText}}" class="remark">备注：{{item.remarkText}}</view>

    <view class="btnRow">
      <button size="mini" class="btn" data-id="{{item._id}}" bindtap="onPrint">打印小票</button>
      <button wx:if="{{item.mode==='ziti' && item.receiverPhone}}" size="mini" class="btn" data-phone="{{item.receiverPhone}}" bindtap="onCopyPhone">复制电话</button>

      <!-- [修正] 绑定 onUpdateStatus -->
      <button
        wx:if="{{!item.refundHandled && (item.status==='paid' || item.status==='making' || item.status==='processing')}}"
        size="mini"
        class="btn primary"
        data-id="{{item._id}}"
        data-status="{{item.mode==='ziti'?'ready':'delivering'}}"
        bindtap="onUpdateStatus"
      >已出餐/发货</button>

      <!-- [修正] 绑定 onUpdateStatus -->
      <button
        wx:if="{{!item.refundHandled && (item.status==='ready' || item.status==='delivering')}}"
        size="mini"
        class="btn primary"
        data-id="{{item._id}}"
        data-status="done"
        bindtap="onUpdateStatus"
      >完成</button>

      <button
        wx:if="{{item.canApplyRefund}}"
        size="mini"
        class="btn danger"
        data-id="{{item._id}}"
        bindtap="onApplyRefund"
      >申请售后</button>
    </view>

    <view wx:if="{{item.refund}}" class="refund">
      <view class="sub">售后：{{item.refund.statusText || '售后处理中'}}</view>
      <view wx:if="{{item.needRefundHandle}}" class="btnRow">
        <button size="mini" class="btn primary" data-id="{{item._id}}" bindtap="goRefundHandle">处理售后</button>
      </view>
    </view>
  </view>

  <view wx:if="{{loading}}" class="tip">加载中…</view>
  <view wx:if="{{!loading && noMore && list.length>0}}" class="tip">没有更多了</view>
  <view wx:if="{{!loading && list.length===0}}" class="tip">暂无订单</view>
</view>

<!-- 快递单号录入弹窗（快递订单使用） -->
<view
  wx:if="{{expressModal.show}}"
  class="modalMask"
  catchtouchmove="noop"
  bindtap="onCloseExpressModal"
>
  <view class="modalCard" catchtap="noop">
    <view class="modalTitle">录入快递单号</view>
    <input
      class="modalInput"
      placeholder="请输入快递单号"
      value="{{expressModal.value}}"
      bindinput="onExpressInput"
    />
    <view class="modalBtnRow">
      <button size="mini" class="btn" bindtap="onCloseExpressModal">取消</button>
      <!-- [修正] 绑定 onConfirmExpress -->
      <button size="mini" class="btn primary" bindtap="onConfirmExpress">保存</button>
    </view>
  </view>
</view>

<admin-tabbar />
</view>
