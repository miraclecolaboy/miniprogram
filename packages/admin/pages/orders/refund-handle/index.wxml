<!-- pages/orders/refund-handle/index.wxml -->
<view class="page">
  <view wx:if="{{order}}" class="card">
    <view class="row">
      <view class="title">订单信息</view>
      <view class="status">{{order.modeText}} · ¥{{order.payAmountText}}</view>
    </view>

    <view class="sub">订单号：{{order.orderNo || order._id}}</view>
    <view class="sub" wx:if="{{order.buyerNickName}}">用户：{{order.buyerNickName}}</view>
    <view class="sub">下单：{{order.createdAtText}}</view>

    <view class="goods">
      <view class="sub">商品：</view>
      <view wx:for="{{order.itemsView}}" wx:key="key" class="goodsLine">{{item.line}}</view>
      <view wx:if="{{order.remarkText}}" class="sub">下单备注：{{order.remarkText}}</view>
    </view>

    <view class="hr"></view>

    <view class="title">售后信息</view>
    <view class="sub">状态：{{order.refundStatusText}}</view>
    <view wx:if="{{order.refundLatestText}}" class="sub">进度：{{order.refundLatestText}}</view>
    <view wx:if="{{order.refundLatestTimeText}}" class="sub">时间：{{order.refundLatestTimeText}}</view>

    <!-- ✅ 同步客户端排序规则：
         处理中：处理备注在上、申请原因在下
         非处理中：申请原因在上、处理备注在下 -->
    <block wx:if="{{order.refundIsProcessing}}">
      <view wx:if="{{order.refundHandleRemarkText}}" class="sub">处理备注：{{order.refundHandleRemarkText}}</view>
      <view wx:if="{{order.refundApplyReasonText}}" class="sub">申请原因：{{order.refundApplyReasonText}}</view>
    </block>
    <block wx:else>
      <view wx:if="{{order.refundApplyReasonText}}" class="sub">申请原因：{{order.refundApplyReasonText}}</view>
      <view wx:if="{{order.refundHandleRemarkText}}" class="sub">处理备注：{{order.refundHandleRemarkText}}</view>
    </block>

    <view class="inputLabel">处理备注（可选）</view>
    <textarea
      class="textarea"
      placeholder="给用户的说明，例如：已同意退款 / 不符合售后条件"
      value="{{remark}}"
      maxlength="200"
      bindinput="onRemarkInput"
    ></textarea>

    <view class="btnRow">
      <button class="btn danger" bindtap="onReject">拒绝</button>
      <button class="btn primary" bindtap="onApprove">同意并退款</button>
    </view>

    <view class="tip">提示：同意售后会发起微信和余额退款（原路退回）。</view>
  </view>

  <view wx:if="{{!order && !loading}}" class="tip">加载失败或订单不存在</view>
</view>
