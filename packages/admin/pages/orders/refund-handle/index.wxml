<view class="page">
  
  <view class="page-header">
    <view class="page-title">售后处理</view>
    <view class="page-sub">审核并处理买家的退款申请</view>
  </view>

  <view wx:if="{{order}}" class="content">
    
    <view class="card">
      <view class="card-title">订单摘要</view>
      
      <view class="info-grid">
        <view class="info-row">
          <text class="info-label">实付金额</text>
          <text class="info-value" style="font-size: 32rpx; font-weight: 800; color: #EF4444;">¥{{order.payAmountText}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">订单类型</text>
          <text class="info-value">{{order.modeText}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">订单编号</text>
          <text class="info-value" user-select>{{order.orderNo || order._id}}</text>
        </view>
        <view class="info-row" wx:if="{{order.buyerNickName}}">
          <text class="info-label">买家昵称</text>
          <text class="info-value" style="color: var(--primary); font-weight: 600;">{{order.buyerNickName}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">下单时间</text>
          <text class="info-value" style="color: var(--text-muted);">{{order.createdAtText}}</text>
        </view>
      </view>

      <view class="goods-block">
        <view wx:for="{{order.itemsView}}" wx:key="key" class="goods-line">
          <text class="goods-dot">•</text>
          <text class="goods-name">{{item.line}}</text>
        </view>
      </view>

      <view class="remark-block" wx:if="{{order.remarkText}}">
        <text class="remark-label">买家备注：</text>
        <text class="remark-text" user-select>{{order.remarkText}}</text>
      </view>
    </view>


    <view class="card">
      <view class="card-title">售后详情</view>

      <view class="info-grid">
        <view class="info-row">
          <text class="info-label">售后状态</text>
          <text class="info-value" style="color: #D97706; font-weight: 800;">{{order.refundStatusText}}</text>
        </view>
        <view class="info-row" wx:if="{{order.refundLatestText}}">
          <text class="info-label">当前进度</text>
          <text class="info-value">{{order.refundLatestText}}</text>
        </view>
        <view class="info-row" wx:if="{{order.refundLatestTimeText}}">
          <text class="info-label">更新时间</text>
          <text class="info-value" style="color: var(--text-muted);">{{order.refundLatestTimeText}}</text>
        </view>

        <block wx:if="{{order.refundIsProcessing}}">
          <view class="info-row" wx:if="{{order.refundHandleRemarkText}}">
            <text class="info-label">处理备注</text>
            <text class="info-value">{{order.refundHandleRemarkText}}</text>
          </view>
          <view class="info-row" wx:if="{{order.refundApplyReasonText}}">
            <text class="info-label">申请原因</text>
            <text class="info-value" style="color: #EF4444; font-weight: 600;">{{order.refundApplyReasonText}}</text>
          </view>
        </block>
        
        <block wx:else>
          <view class="info-row" wx:if="{{order.refundApplyReasonText}}">
            <text class="info-label">申请原因</text>
            <text class="info-value">{{order.refundApplyReasonText}}</text>
          </view>
          <view class="info-row" wx:if="{{order.refundHandleRemarkText}}">
            <text class="info-label">处理备注</text>
            <text class="info-value">{{order.refundHandleRemarkText}}</text>
          </view>
        </block>
      </view>
    </view>


    <view class="card">
      <view class="card-title">审批操作</view>
      
      <view class="form-group">
        <view class="label">处理备注（可选）</view>
        <textarea 
          class="textarea" 
          placeholder="给用户的说明，例如：已同意退款 / 不符合售后条件" 
          value="{{remark}}" 
          maxlength="200" 
          bindinput="onRemarkInput"
        ></textarea>
      </view>

      <view class="action-row">
        <view class="btn btn-danger" bindtap="onReject">拒绝申请</view>
        <view class="btn btn-primary" bindtap="onApprove">同意并退款</view>
      </view>

      <view class="hint-center">提示：同意售后会发起微信和余额退款（原路退回）。</view>
    </view>

    <view style="height: 60rpx;"></view>

  </view>

  <view wx:if="{{!order && !loading}}" class="empty-hint">加载失败或该售后单不存在</view>
</view>