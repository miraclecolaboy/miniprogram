<view class="page">
  <scroll-view class="main-scroll" scroll-y="true" enhanced="true" enable-back-to-top="true" show-scrollbar="{{false}}">
    <view class="page-header row-between">
      <view class="header-left">
        <view class="page-title">店铺配置</view>
        <!-- <view class="page-sub">核销优先 / 分组折叠 / 便捷操作</view> -->
      </view>
      <view class="btn btn-outline btn-mini" bindtap="onReload">刷新数据</view>
    </view>

    <view class="page-content">
      <view class="fold-card {{sectionOpen.consume ? 'is-open' : ''}}">
        <view class="fold-head" bindtap="toggleSection" data-key="consume">
          <view class="fold-head-main">
            <view class="fold-title">快速核销</view>
            <view class="fold-sub">输入 6 位码，核销后自动清空</view>
          </view>
          <view class="fold-arrow">{{sectionOpen.consume ? '收起' : '展开'}}</view>
        </view>
        <view class="fold-body" wx:if="{{sectionOpen.consume}}">
          <view class="card compact-card consume-card">
            <view class="list-row" style="border-bottom: none; padding-bottom: 0;">
              <view class="row-label">6位核销码</view>
              <input class="input-inline consume-input" type="number" value="{{consumeCode}}" bindinput="onConsumeCodeInput" maxlength="6" placeholder="输入6位数字" />
            </view>
            <view class="hint consume-tip" wx:if="{{consumeTip}}">{{consumeTip}}</view>
            <view class="card-action">
              <view class="btn btn-primary" bindtap="onConsume">立即核销</view>
            </view>
          </view>
        </view>
      </view>

      <view class="fold-card {{sectionOpen.shopInfo ? 'is-open' : ''}}">
        <view class="fold-head" bindtap="toggleSection" data-key="shopInfo">
          <view class="fold-head-main">
            <view class="fold-title">店铺信息</view>
            <view class="fold-sub">公告、轮播、客服、营业、云打印</view>
          </view>
          <view class="fold-arrow">{{sectionOpen.shopInfo ? '收起' : '展开'}}</view>
        </view>
        <view class="fold-body" wx:if="{{sectionOpen.shopInfo}}">
          <view class="card compact-card">
            <view class="card-title">基础外观</view>
            <view class="form-group">
              <view class="label">下单页公告</view>
              <textarea class="textarea" maxlength="20" value="{{notice}}" placeholder="输入公告（最多20字）" bindinput="onNoticeInput"></textarea>
              <view class="card-action">
                <view class="btn {{noticeChanged ? 'btn-primary' : 'btn-disabled'}}" bindtap="onSaveNotice">保存公告</view>
              </view>
            </view>
            <view class="divider"></view>
            <view class="form-group">
              <view class="label">店铺首页轮播图</view>
              <view class="hint">展示在客户端首页顶部，比例 4:3</view>
              <view class="banner-list">
                <view class="banner-item" wx:for="{{banners}}" wx:key="key">
                  <image src="{{item.preview}}" mode="aspectFill" class="banner-img" />
                  <view catchtap="onRemoveBanner" data-index="{{index}}" class="banner-del">×</view>
                </view>
                <view bindtap="onUploadBanner" class="banner-add">+</view>
              </view>
              <view class="card-action">
                <view class="btn {{configChanged ? 'btn-primary' : 'btn-disabled'}}" bindtap="onSaveConfig">保存轮播图</view>
              </view>
            </view>
          </view>

          <view class="card compact-card">
            <view class="card-title">客服与营业时间</view>
            <view class="list-row">
              <view class="row-label">联系电话</view>
              <input class="input-inline" style="width: 300rpx;" type="text" value="{{phone}}" bindinput="onPhoneInput" placeholder="选填" />
            </view>
            <view class="form-group" style="margin-top: 24rpx;">
              <view class="label" style="margin-bottom: 8rpx;">营业时段</view>
              <view class="hint">留空则默认 10:00-22:00；营业时间最多两段</view>
              <view class="time-range-row" wx:for="{{serviceHoursRanges}}" wx:key="index">
                <input class="time-input" type="number" maxlength="2" value="{{item.sh}}" placeholder="10" data-index="{{index}}" data-field="sh" bindinput="onServiceHourPartInput" />
                <text class="time-sep">:</text>
                <input class="time-input" type="number" maxlength="2" value="{{item.sm}}" placeholder="00" data-index="{{index}}" data-field="sm" bindinput="onServiceHourPartInput" />
                <text class="time-sep">-</text>
                <input class="time-input" type="number" maxlength="2" value="{{item.eh}}" placeholder="22" data-index="{{index}}" data-field="eh" bindinput="onServiceHourPartInput" />
                <text class="time-sep">:</text>
                <input class="time-input" type="number" maxlength="2" value="{{item.em}}" placeholder="00" data-index="{{index}}" data-field="em" bindinput="onServiceHourPartInput" />
                <view wx:if="{{serviceHoursRanges.length > 1}}" class="btn btn-danger btn-mini" style="margin-left: 12rpx;" data-index="{{index}}" bindtap="onRemoveServiceHoursRange">删除</view>
              </view>
              <view class="card-action" style="justify-content: flex-start;" wx:if="{{serviceHoursRanges.length < 2}}">
                <view class="btn btn-outline btn-mini" bindtap="onAddServiceHoursRange">+ 添加时段</view>
              </view>
            </view>
            <view class="divider"></view>
            <view class="form-group">
              <view class="row-between">
                <view class="label" style="margin: 0;">客服二维码 (选填)</view>
                <view class="btn btn-outline btn-mini" bindtap="onUploadKefuQr">上传二维码</view>
              </view>
              <image wx:if="{{kefuQrPreview}}" class="qr-preview" src="{{kefuQrPreview}}" mode="aspectFill" lazy-load="true" />
              <view class="card-action" style="justify-content: flex-start;" wx:if="{{kefuQrPreview}}">
                <view class="btn btn-danger btn-mini" bindtap="onRemoveKefuQr">删除图片</view>
              </view>
            </view>
            <view class="card-action">
              <view class="btn {{contactChanged ? 'btn-primary' : 'btn-disabled'}}" bindtap="onSaveContact">保存客服信息</view>
            </view>
          </view>

          <view class="card compact-card">
            <view class="card-title">云打印配置 (飞鹅云)</view>
            <view class="row-between printer-status-row">
              <view class="printer-status-main">
                <view class="printer-status-title">打印机状态</view>
                <view class="hint" style="margin-top: 4rpx;">{{cloudPrintStatusText}}</view>
              </view>
              <view class="printer-dot {{cloudPrintStatusOk ? 'is-on' : 'is-off'}}"></view>
            </view>
            <view class="card-action" style="margin-top: 16rpx;">
              <view class="btn btn-outline" bindtap="onRefreshCloudPrintStatus">刷新状态</view>
              <view class="btn btn-outline" bindtap="onTestCloudPrint">测试打印</view>
            </view>
            <view class="hint" style="margin-bottom: 24rpx;">新订单将自动打印，请确保打印机在线。</view>
            <view class="list-row">
              <view class="row-label">打印机 SN</view>
              <input class="input-inline" style="width: 350rpx;" type="text" value="{{cloudPrinterSn}}" bindinput="onCloudPrintInput" data-field="cloudPrinterSn" placeholder="必填" />
            </view>
            <view class="list-row">
              <view class="row-label">飞鹅云 USER</view>
              <input class="input-inline" style="width: 350rpx;" type="text" value="{{cloudPrinterUser}}" bindinput="onCloudPrintInput" data-field="cloudPrinterUser" placeholder="必填" />
            </view>
            <view class="list-row">
              <view class="row-label">飞鹅云 UKEY</view>
              <input class="input-inline" style="width: 350rpx;" type="text" value="{{cloudPrinterKey}}" bindinput="onCloudPrintInput" data-field="cloudPrinterKey" placeholder="必填" />
            </view>
            <view class="list-row">
              <view class="row-label">打印联数</view>
              <input class="input-inline" type="number" value="{{cloudPrinterTimes}}" bindinput="onCloudPrintInput" data-field="cloudPrinterTimes" placeholder="默认 1" />
            </view>
            <view class="card-action">
              <view class="btn {{cloudPrintChanged ? 'btn-primary' : 'btn-disabled'}}" bindtap="onSaveCloudPrint">保存打印配置</view>
            </view>
          </view>
        </view>
      </view>

      <view class="fold-card {{sectionOpen.deliveryPay ? 'is-open' : ''}}">
        <view class="fold-head" bindtap="toggleSection" data-key="deliveryPay">
          <view class="fold-head-main">
            <view class="fold-title">配送配置</view>
            <view class="fold-sub">外卖/同城快递配置</view>
          </view>
          <view class="fold-arrow">{{sectionOpen.deliveryPay ? '收起' : '展开'}}</view>
        </view>
        <view class="fold-body" wx:if="{{sectionOpen.deliveryPay}}">
          <view class="card compact-card">
            <view class="card-title">配送与起送</view>
            <view class="list-row">
              <view class="row-label">开启外卖</view>
              <switch checked="{{waimaiOn}}" bindchange="onWaimaiOnChange" color="#10B981" />
            </view>
            <view class="list-row">
              <view class="row-label">外卖最大距离 (km)</view>
              <input class="input-inline" type="number" value="{{waimaiMaxKm}}" bindinput="onWaimaiMaxKmInput" placeholder="0" />
            </view>
            <view class="list-row">
              <view class="row-label">外卖配送费 (元)</view>
              <input class="input-inline" type="digit" value="{{waimaiDeliveryFee}}" bindinput="onWaimaiDeliveryFeeInput" placeholder="0.00" />
            </view>
            <view class="list-row">
              <view class="row-label">外卖免配送门槛 (元)</view>
              <input class="input-inline" type="digit" value="{{minOrderWaimai}}" bindinput="onMinOrderWaimaiInput" placeholder="0.00" />
            </view>
            <view class="divider" style="margin: 10rpx 0;"></view>
            <view class="list-row">
              <view class="row-label">开启全国快递</view>
              <switch checked="{{kuaidiOn}}" bindchange="onKuaidiOnChange" color="#10B981" />
            </view>
            <view class="list-row">
              <view class="row-label">快递配送费 (元)</view>
              <input class="input-inline" type="digit" value="{{kuaidiDeliveryFee}}" bindinput="onKuaidiDeliveryFeeInput" placeholder="0.00" />
            </view>
            <view class="list-row">
              <view class="row-label">省内快递免配送门槛 (元)</view>
              <input class="input-inline" type="digit" value="{{minOrderKuaidi}}" bindinput="onMinOrderKuaidiInput" placeholder="0.00" />
            </view>
            <view class="list-row">
              <view class="row-label">省外判定距离 (km)</view>
              <input class="input-inline" type="digit" value="{{kuaidiOutProvinceDistanceKm}}" bindinput="onKuaidiOutProvinceDistanceKmInput" placeholder="300" />
            </view>
            <view class="list-row">
              <view class="row-label">省外配送费 (元)</view>
              <input class="input-inline" type="digit" value="{{kuaidiOutDeliveryFee}}" bindinput="onKuaidiOutDeliveryFeeInput" placeholder="0.00" />
            </view>
            <view class="list-row">
              <view class="row-label">省外快递免配送门槛 (元)</view>
              <input class="input-inline" type="digit" value="{{minOrderKuaidiOut}}" bindinput="onMinOrderKuaidiOutInput" placeholder="140" />
            </view>
            <view class="card-action">
              <view class="btn {{configChanged ? 'btn-primary' : 'btn-disabled'}}" bindtap="onSaveConfig">保存配送配置</view>
            </view>
          </view>

        </view>
      </view>

      <view class="fold-card {{sectionOpen.coupons ? 'is-open' : ''}}">
        <view class="fold-head" bindtap="toggleSection" data-key="coupons">
          <view class="fold-head-main">
            <view class="fold-title">优惠券管理</view>
            <view class="fold-sub">新增/编辑/删除（{{coupons.length}}）</view>
          </view>
          <view class="fold-arrow">{{sectionOpen.coupons ? '收起' : '展开'}}</view>
        </view>
        <view class="fold-body" wx:if="{{sectionOpen.coupons}}">
          <view class="card compact-card">
            <view class="card-title">{{editingCouponId ? '编辑优惠券' : '新增优惠券'}}</view>
            <view class="hint" wx:if="{{editingCouponTitle}}" style="margin-bottom: 16rpx; color: var(--warning);">正在编辑：{{editingCouponTitle}}</view>
            <view class="list-row">
              <view class="row-label">标题</view>
              <input class="input-inline" style="width: 350rpx;" type="text" value="{{couponForm.title}}" bindinput="onCouponFormInput" data-field="title" placeholder="如：新人5元券" />
            </view>
            <view class="list-row">
              <view class="row-label">最低消费 (元)</view>
              <input class="input-inline" type="digit" value="{{couponForm.minSpend}}" bindinput="onCouponFormInput" data-field="minSpend" placeholder="0为无门槛" />
            </view>
            <view class="list-row">
              <view class="row-label">减免金额 (元)</view>
              <input class="input-inline" type="digit" value="{{couponForm.discount}}" bindinput="onCouponFormInput" data-field="discount" placeholder="0.00" />
            </view>
            <view class="list-row">
              <view class="row-label">发放总量</view>
              <input class="input-inline" type="number" value="{{couponForm.totalQuantity}}" bindinput="onCouponFormInput" data-field="totalQuantity" placeholder="必填" />
            </view>
            <view class="card-action">
              <view class="btn btn-outline" wx:if="{{editingCouponId}}" bindtap="cancelCouponEdit">取消</view>
              <view class="btn {{couponSaving ? 'btn-disabled' : 'btn-primary'}}" bindtap="saveCouponForm">{{editingCouponId ? '保存修改' : '新增优惠券'}}</view>
            </view>
          </view>

          <view class="card compact-card">
            <view class="card-title">已配置优惠券 ({{coupons.length}})</view>
            <view class="empty-hint" wx:if="{{!coupons.length}}">暂无优惠券，请在上方新增</view>

            <view class="data-item" wx:for="{{coupons}}" wx:key="_id">
              <view class="data-main">
                <view class="data-title">
                  {{item.title}}
                  <text class="badge {{item.status === 'active' ? 'badge-success' : 'badge-disabled'}}">{{item.status === 'active' ? '上架中' : '已下架'}}</text>
                </view>
                <view class="data-sub">满 {{item.minSpend}} 减 {{item.discount}}</view>
                <view class="data-sub">总量: {{item.totalQuantity}} / 已领: {{item.claimedQuantity || 0}}</view>
              </view>
              <view class="data-side">
                <view class="btn btn-mini btn-outline" bindtap="openEditCoupon" data-id="{{item._id}}">编辑</view>
                <view class="btn btn-mini btn-danger" bindtap="deleteCoupon" data-id="{{item._id}}">
                  删除
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <view class="fold-card {{sectionOpen.gifts ? 'is-open' : ''}}">
        <view class="fold-head" bindtap="toggleSection" data-key="gifts">
          <view class="fold-head-main">
            <view class="fold-title">兑换商品管理</view>
            <view class="fold-sub">新增/编辑/删除（{{gifts.length}}）</view>
          </view>
          <view class="fold-arrow">{{sectionOpen.gifts ? '收起' : '展开'}}</view>
        </view>
        <view class="fold-body" wx:if="{{sectionOpen.gifts}}">
          <view class="card compact-card">
            <view class="card-title">{{editingGiftId ? '编辑兑换商品' : '新增兑换商品'}}</view>
            <view class="hint" wx:if="{{editingGiftName}}" style="margin-bottom: 16rpx; color: var(--warning);">正在编辑：{{editingGiftName}}</view>
            <view class="list-row">
              <view class="row-label">商品名字</view>
              <input class="input-inline" style="width: 350rpx;" type="text" value="{{giftForm.name}}" bindinput="onGiftNameInput" placeholder="必填" />
            </view>
            <view class="list-row">
              <view class="row-label">所需积分</view>
              <input class="input-inline" type="number" value="{{giftForm.points}}" bindinput="onGiftPointsInput" placeholder="必填" />
            </view>
            <view class="list-row">
              <view class="row-label">数量(库存)</view>
              <input class="input-inline" type="number" value="{{giftForm.quantity}}" bindinput="onGiftQuantityInput" placeholder="必填" />
            </view>
            <view class="form-group" style="margin-top: 24rpx;">
              <view class="label">描述信息</view>
              <textarea class="textarea" style="min-height: 100rpx;" maxlength="20" value="{{giftForm.desc}}" bindinput="onGiftDescInput" placeholder="选填，最多20字"></textarea>
            </view>
            <view class="form-group">
              <view class="row-between">
                <view class="label" style="margin: 0;">商品主图 (选填)</view>
                <view class="btn btn-outline btn-mini" bindtap="onUploadGiftThumb">上传图片</view>
              </view>
              <image wx:if="{{giftForm.thumbPreview}}" class="thumb-preview" src="{{giftForm.thumbPreview}}" mode="aspectFill" lazy-load="true" />
            </view>
            <view class="card-action">
              <view class="btn btn-outline" wx:if="{{editingGiftId}}" bindtap="onCancelEdit">取消</view>
              <view class="btn btn-primary" bindtap="onSaveGift">{{editingGiftId ? '保存修改' : '新增礼品'}}</view>
            </view>
          </view>

          <view class="card compact-card">
            <view class="card-title">已配置兑换商品 ({{gifts.length}})</view>
            <view class="empty-hint" wx:if="{{!gifts.length}}">暂无兑换商品，请在上方新增</view>
            <view class="data-item" wx:for="{{gifts}}" wx:key="id">
              <image wx:if="{{item.thumbUrl}}" class="item-thumb" src="{{item.thumbUrl}}" mode="aspectFill" lazy-load="true" />
              <view class="data-main">
                <view class="data-title">{{item.name}}</view>
                <view class="data-sub" style="color: var(--warning); font-weight: 600;">所需积分: {{item.points}}</view>
                <view class="data-sub">库存: {{item.totalQuantity > 0 ? (item.leftQuantity + ' / ' + item.totalQuantity) : '不限'}}</view>
                <view class="data-sub" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">{{item.desc}}</view>
              </view>
              <view class="data-side">
                <view class="btn btn-mini btn-outline" bindtap="onEditGift" data-id="{{item.id}}">编辑</view>
                <view class="btn btn-mini btn-danger" bindtap="onDisableGift" data-id="{{item.id}}">删除</view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <view style="height: 180rpx;"></view>
    </view>
  </scroll-view>

  <admin-tabbar />
  <canvas canvas-id="image-cropper" style="position:fixed; left:-9999px; width:300px; height:300px;"></canvas>
</view>
