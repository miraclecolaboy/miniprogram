<view class="page">
  <scroll-view class="main-scroll" scroll-y="true">
    
    <view class="card header-card">
      
      <block wx:if="{{mode === 'ziti'}}">
        <view class="sub-mode-toggle">
          <view class="toggle-item {{storeSubMode === 'tangshi' ? 'active' : ''}}" 
                bindtap="switchStoreSubMode" data-sub="tangshi">
            <image class="toggle-icon" src="/assets/in-store.png" mode="aspectFit" />
            <text>堂食 Eat In</text>
          </view>
          <view class="toggle-item {{storeSubMode === 'ziti' ? 'active' : ''}}" 
                bindtap="switchStoreSubMode" data-sub="ziti">
            <image class="toggle-icon" src="/assets/take-away.png" mode="aspectFit" />
            <text>自提 Pick Up</text>
          </view>
        </view>

        <view class="store-info-container">
          <view class="store-row">
            <text class="store-name">{{storeName}}</text>
            <text class="store-dist" wx:if="{{distance}}">距您 {{distance}}{{distanceUnit}}</text>
          </view>
          
          <picker wx:if="{{storeSubMode === 'ziti'}}" mode="selector" range="{{timeList}}" bindchange="choosePickupTime">
            <view class="pickup-time-row">
              <text class="label">取餐时间</text>
              <view class="value-wrap">
                <text class="time-val">{{pickupTime}}</text>
                <text class="arrow">></text>
              </view>
            </view>
          </picker>
        </view>
      </block>

      <block wx:else>
        <view class="delivery-header">
          <text class="dh-title">外卖配送 Delivery</text>
        </view>
        <view class="address-box" bindtap="chooseAddress">
          <block wx:if="{{address}}">
            <view class="addr-content">
              <text class="addr-main">{{address.fullAddress}}</text>
              <text class="addr-sub">{{address.name}} {{address.phone}}</text>
            </view>
            <text class="arrow">></text>
          </block>
          <block wx:else>
            <view class="addr-placeholder">
              <view class="plus-btn">+</view>
              <text>选择收货地址</text>
            </view>
          </block>
        </view>
      </block>
    </view>

    <view class="card product-card">
      <view class="product-list">
        <block wx:for="{{cart}}" wx:key="uniqueKey" wx:if="{{index < 3 || isCartExpanded}}">
          <view class="p-item">
            <image class="p-img" src="{{item.img}}" mode="aspectFill" />
            <view class="p-info">
              <view class="p-row">
                <text class="p-name">{{item.name}}</text>
                <text class="p-price">￥{{item.total}}</text>
              </view>
              <view class="p-row sub-row">
                <text class="p-spec">{{item.specText}}</text>
                <text class="p-count">x{{item.count}}</text>
              </view>
            </view>
          </view>
        </block>
      </view>

      <view class="expand-btn" wx:if="{{cart.length > 3}}" bindtap="toggleCartExpand">
        <text>{{isCartExpanded ? '收起商品' : '展开更多 (' + (cart.length - 3) + ')'}}</text>
        <text class="arrow-down {{isCartExpanded ? 'up' : ''}}">⌄</text>
      </view>

      <view class="fee-section">
        <view class="fee-row" wx:if="{{mode !== 'ziti'}}">
          <text class="fee-lbl">配送费</text>
          <text class="fee-val">￥{{deliveryFee}}</text>
        </view>
        <view class="fee-tip" wx:if="{{mode !== 'ziti' && needMoreFreeDelivery > 0}}">
          再买 ￥{{needMoreFreeDelivery}} 免配送费
        </view>
      </view>
    </view>

    <view class="card option-card">
      <view class="cell-item" bindtap="onSelectCoupon">
        <text class="cell-lbl">优惠券</text>
        <view class="cell-right {{couponDiscount > 0 ? 'highlight-red' : ''}}">
          {{couponDiscount > 0 ? '-￥'+couponDiscount : (availableCouponsCount > 0 ? availableCouponsCount + '张可用' : '无可用')}}
          <text class="arrow">></text>
        </view>
      </view>

      <view class="cell-item" wx:if="{{isVip}}">
        <view class="vip-wrapper">
          <text class="cell-lbl">会员折扣</text>
          <view class="vip-badge">VIP</view>
        </view>
        <view class="cell-right highlight-red">-￥{{vipDiscount}}</view>
      </view>

      <view class="cell-item input-item">
        <text class="cell-lbl">备注</text>
        <input class="remark-input" placeholder="口味、包装等要求" placeholder-class="ph-color" bindinput="onRemarkInput" />
      </view>
    </view>

    <view class="card pay-card">
      <view class="cell-item" bindtap="openPaySheet">
        <text class="cell-lbl">支付方式</text>
        <view class="cell-right highlight-black">
          {{payMethodText}}
          <text class="arrow">></text>
        </view>
      </view>
    </view>

    <view class="footer-spacer"></view>
  </scroll-view>

  <view class="bottom-bar">
    <view class="bar-left">
      <view class="final-price-row">
        <text class="symbol">￥</text>
        <text class="big-num">{{finalPay}}</text>
      </view>
      <text class="discount-tip" wx:if="{{couponDiscount > 0 || vipDiscount > 0}}">已优惠 ￥{{(vipDiscount*1 + couponDiscount*1)}}</text>
    </view>
    <view class="pay-btn" bindtap="onPayTap">立即支付</view>
  </view>

  <action-sheet hidden="{{!paySheetVisible}}" bindchange="closePaySheet">
    <action-sheet-item bindtap="choosePay" data-method="wechat">微信支付</action-sheet-item>
    <action-sheet-item bindtap="choosePay" data-method="balance">
      余额支付 (剩余: ￥{{balanceText}})
    </action-sheet-item>
    <action-sheet-item bindtap="closePaySheet">取消</action-sheet-item>
  </action-sheet>
</view>