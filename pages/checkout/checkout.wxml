<view class="page">
  <view class="header-section">
    <view class="submode-tabs" wx:if="{{mode === 'ziti'}}">
      <view class="submode-tab {{storeSubMode === 'tangshi' ? 'active' : ''}}" bindtap="changeStoreSubMode" data-submode="tangshi" hover-class="hover-opacity">
        <image class="submode-icon" src="/assets/in-store.png" mode="aspectFit" />
        <text>堂食</text>
      </view>
      <view class="submode-tab {{storeSubMode !== 'tangshi' ? 'active' : ''}}" bindtap="changeStoreSubMode" data-submode="ziti" hover-class="hover-opacity">
        <image class="submode-icon" src="/assets/take-away.png" mode="aspectFit" />
        <text>自提</text>
      </view>
    </view>

    <view class="main-info-box">
      <block wx:if="{{mode === 'ziti'}}">
        <view class="store-info">
          <text class="store-name">{{storeName || '加载中...'}}</text>
          <text class="distance-tag" wx:if="{{distance}}">距您 {{distance}}{{distanceUnit}}</text>
        </view>
        <picker mode="selector" range="{{timeList}}" bindchange="choosePickupTime">
          <view class="pickup-time-row">
            <text class="label">{{storeSubMode === 'tangshi' ? '到店时间' : '取餐时间'}}</text>
            <view class="time-val">
              {{pickupTime}} <text class="arrow">></text>
            </view>
          </view>
        </picker>
      </block>

      <block wx:else>
        <view class="address-info" bindtap="chooseAddress">
          <block wx:if="{{address}}">
            <text class="addr-detail">{{address.fullAddress}}</text>
            <text class="user-detail">{{address.name}} {{address.phone}}</text>
          </block>
          <block wx:else>
            <text class="addr-placeholder">请选择收货地址</text>
          </block>
          <text class="arrow-right">></text>
        </view>
      </block>
    </view>
  </view>

  <view class="card product-card">
    <block wx:for="{{cart}}" wx:key="id" wx:for-item="p">
      <view class="product-item">
        <image class="p-img" src="{{p.img || ''}}" mode="aspectFill" />
        <view class="p-content">
          <view class="p-row-top">
            <text class="p-name">{{p.name}}</text>
            <text class="p-price">￥{{p.total}}</text>
          </view>
          <view class="p-row-bottom">
            <text class="p-spec">{{p.specText || ''}}</text>
            <text class="p-count">x{{p.count}}</text>
          </view>
        </view>
      </view>
    </block>
    
    <view class="fee-row" wx:if="{{mode !== 'ziti'}}">
      <text class="label">配送费</text>
      <text class="val">￥{{deliveryFee}}</text>
    </view>
    <view class="fee-tip" wx:if="{{mode !== 'ziti' && needMoreFreeDelivery !== '0.00'}}">
      再买 ￥{{needMoreFreeDelivery}} 免配送费
    </view>
  </view>

  <view class="card benefit-card">
    <view class="cell-row" bindtap="onSelectCoupon" hover-class="hover-opacity">
      <text class="cell-label">优惠券</text>
      <view class="cell-right">
        <view wx:if="{{selectedCoupon}}" class="coupon-cell">
          <text class="coupon-cell-title">{{selectedCoupon.title}}</text>
          <text class="coupon-cell-discount">-￥{{couponDiscount}}</text>
        </view>
        <text wx:else class="coupon-cell-placeholder">{{availableCoupons.length ? availableCoupons.length + '张可用' : '无可用'}}</text>
        <text class="arrow">></text>
      </view>
    </view>
    
    <view class="cell-row" wx:if="{{!isVip}}" bindtap="goOpenVip">
      <text class="cell-label">会员折扣</text>
      <view class="cell-right" style="color: var(--gold-dark); font-weight: 500;">
        <text class="shimmer-anim">开通立减 ￥{{vipDiscount}}</text>
        <text class="arrow">></text>
      </view>
    </view>

    <view class="cell-row" wx:if="{{isVip}}">
      <view style="display: flex; align-items: center;">
        <text class="cell-label">会员折扣</text>
        <text class="vip-tag">VIP</text>
      </view>
      <view class="cell-right highlight-gold">-￥{{vipDiscount}}</view>
    </view>
    
    <view class="cell-row">
      <text class="cell-label">本单获得积分</text>
      <view class="cell-right">{{points}}</view>
    </view>
  </view>

  <view class="card">
    <view class="card-title">支付方式</view>
    
    <view class="pay-option" bindtap="choosePay" data-method="wechat">
      <view class="pay-left">
        <image class="pay-icon-img" src="/assets/wechat.png" mode="aspectFit" />
        <text class="pay-main-text">微信支付</text>
      </view>
      <view class="radio-circle {{payMethod==='wechat'?'checked':''}}">
        <view class="radio-dot" wx:if="{{payMethod==='wechat'}}"></view>
      </view>
    </view>
    
    <view class="pay-option" bindtap="choosePay" data-method="balance">
      <view class="pay-left">
        <image class="pay-icon-img" src="/assets/wallet.png" mode="aspectFit" />
        <view class="pay-text-group">
          <text class="pay-main-text">余额支付</text>
          <text class="pay-sub-text">可用余额: ￥{{balanceText}}</text>
        </view>
      </view>
      <view class="radio-circle {{payMethod==='balance'?'checked':''}}">
        <view class="radio-dot" wx:if="{{payMethod==='balance'}}"></view>
      </view>
    </view>
  </view>

  <view class="card">
    <view class="cell-row">
      <text class="cell-label">备注</text>
      <input class="remark-input" placeholder="请输入口味、包装等要求" placeholder-class="ph-color" bindinput="onRemarkInput" />
    </view>
  </view>

</view>

<view class="bottom-bar">
  <view class="bar-left" bindtap="showPriceDetail" hover-class="hover-opacity">
    <view class="price-box">
      <text class="currency">￥</text>
      <text class="total-num">{{finalPay}}</text>
    </view>
    <view class="discount-tip" wx:if="{{(vipDiscount*1 + couponDiscount*1) > 0}}">
      已优惠 ￥{{vipDiscount*1 + couponDiscount*1}}
    </view>
  </view>
  
  <view class="pay-btn" bindtap="onPayTap">立即支付</view>
</view>

<!-- 优惠券弹窗 -->
<view class="coupon-mask" wx:if="{{showCouponPopup}}" bindtap="closeCouponPopup" catchtouchmove="noop"></view>
<view class="coupon-sheet" wx:if="{{showCouponPopup}}" catchtap="noop" catchtouchmove="noop">
  <view class="coupon-handle-bar"><view class="coupon-handle"></view></view>

  <view class="coupon-header">
    <text class="coupon-sheet-title">选择优惠券</text>
    <view class="coupon-close" bindtap="closeCouponPopup" hover-class="hover-opacity">×</view>
  </view>
  <view class="coupon-sub">{{availableCoupons.length}} 张可用</view>

  <scroll-view class="coupon-list" scroll-y="true" enhanced="true" show-scrollbar="false">
    <view class="coupon-option coupon-none {{!selectedCoupon ? 'active' : ''}}" bindtap="useNoCoupon" hover-class="hover-opacity">
      <view class="coupon-main">
        <text class="coupon-none-text">不使用优惠券</text>
      </view>
      <view class="coupon-radio {{!selectedCoupon ? 'checked' : ''}}">
        <view class="coupon-radio-dot" wx:if="{{!selectedCoupon}}"></view>
      </view>
    </view>

    <view
      class="coupon-option {{selectedCouponKey === item.groupKey ? 'active' : ''}}"
      wx:for="{{availableCoupons}}"
      wx:key="groupKey"
      data-key="{{item.groupKey}}"
      bindtap="useCoupon"
      hover-class="hover-opacity"
    >
      <view class="coupon-left">
        <text class="coupon-currency">￥</text>
        <text class="coupon-discount">{{item.discount}}</text>
      </view>

      <view class="coupon-main">
        <view class="coupon-main-top">
          <text class="coupon-name">{{item.title}}</text>
          <text class="coupon-count" wx:if="{{item.count > 1}}">x{{item.count}}</text>
        </view>
        <text class="coupon-rule">{{item.minSpend > 0 ? ('满' + item.minSpend + '元可用') : '无门槛'}}</text>
      </view>

      <view class="coupon-radio {{selectedCouponKey === item.groupKey ? 'checked' : ''}}">
        <view class="coupon-radio-dot" wx:if="{{selectedCouponKey === item.groupKey}}"></view>
      </view>
    </view>
  </scroll-view>
</view>
