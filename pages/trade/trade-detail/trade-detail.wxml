<view class="page" wx:if="{{order}}">
  <scroll-view class="page-scroll" scroll-y="true" enhanced="true" show-scrollbar="{{false}}">
  
  <view class="header-area">
    <view class="status-big-title">
      <text>{{order.statusText}}</text>
    </view>
    
    <block wx:if="{{order.status === 'processing'}}">
      <view class="status-desc" wx:if="{{order.pickupInfo.time}}">
        订单已确认，请于 <text class="highlight">{{order.pickupInfo.time}}</text> 到店取餐
      </view>
      <view class="status-desc" wx:else>
        订单已确认，请留意出餐提醒
      </view>
    </block>

    <view class="status-desc" wx:elif="{{order.status === 'ready'}}">商品已打包好，请前往取餐</view>
    <view class="status-desc" wx:elif="{{order.status === 'delivering'}}">骑手正在配送中，请保持电话畅通</view>
    <view class="status-desc" wx:elif="{{order.status === 'done'}}">感谢您的光临，期待再次相遇</view>
    <view class="status-desc" wx:else>订单已结束</view>

    <view class="progress-line">
      <view class="progress-active {{order.status}}" style="width: {{order.status==='done'? '100%' : (order.status==='ready' || order.status==='delivering' ? '80%' : '40%')}}"></view>
    </view>
  </view>

  <view class="main-content">
    
    <view class="card pickup-card" wx:if="{{order.mode === 'ziti' && order.pickupInfo.code}}">
      <view class="pickup-label">取餐号 Pickup No.</view>
      <view class="pickup-code">{{order.pickupInfo.code}}</view>
      <view class="pickup-status-bar">
        <text wx:if="{{order.status === 'ready'}}">请凭此号取餐</text>
        <text wx:elif="{{order.pickupInfo.time}}">预约 {{order.pickupInfo.time}} 取餐</text>
        <text wx:else>等待叫号取餐</text>
      </view>
    </view>

    <view class="card address-card" bindtap="openNavigate">
      <view class="card-header">
        <text class="addr-name">{{order.mode === 'ziti' ? (shopCfg.storeName || '门店') : '配送信息'}}</text>
        <image class="icon-img" src="/assets/location.png" mode="aspectFit" />
      </view>
      
      <view class="addr-detail-box">
        <block wx:if="{{order.mode === 'ziti'}}">
          <text class="addr-text">{{shopCfg.storeAddress || '请在后台配置门店地址'}}</text>
        </block>
        <block wx:else>
          <view class="addr-text">{{order.shippingInfo.region}}{{order.shippingInfo.detail}}</view>
          <view class="addr-user">{{order.shippingInfo.name}} {{order.shippingInfo.phone}}</view>
        </block>
      </view>
    </view>

    <view class="card goods-card">
      <view class="goods-list">
        <view class="goods-item" wx:for="{{order.items}}" wx:key="productId">
          <image class="goods-img" src="{{item.image}}" mode="aspectFill" lazy-load />
          <view class="goods-content">
            <view class="goods-row-top">
              <view class="goods-name">{{item.productName}}</view>
              <view class="goods-price">￥{{item.price}}</view>
            </view>
            <view class="goods-row-bottom">
              <view class="goods-spec" wx:if="{{item.specText}}">{{item.specText}}</view>
              <view class="goods-spec" wx:else></view>
              <view class="goods-count">x{{item.count}}</view>
            </view>
          </view>
        </view>
      </view>

      <view class="divider-dashed"></view>

      <view class="cost-section">
        <view class="cost-row">
          <text>商品小计</text>
          <text class="cost-val">￥{{order.amount.goods}}</text>
        </view>
        <view class="cost-row">
          <text>配送费</text>
          <text class="cost-val">￥{{order.amount.delivery}}</text>
        </view>
        <view class="cost-row discount" wx:if="{{order.isVip}}">
          <text>会员折扣</text>
          <text class="cost-val">-￥{{order.amount.vipDiscount}}</text>
        </view>
        <view class="cost-row discount" wx:if="{{order.amount.couponDiscount !== '0.00'}}">
          <text>优惠券</text>
          <text class="cost-val">-￥{{order.amount.couponDiscount}}</text>
        </view>
        
        <view class="total-row">
          <text class="total-count-lbl">共 {{order.totalCount || order.items.length}} 件，</text>
          <text class="total-lbl">实付</text>
          <text class="total-val">￥{{order.totalPrice}}</text>
        </view>
      </view>
    </view>

    <view class="card info-card">
      <view class="card-header" bindtap="toggleInfoExpand" style="margin-bottom: {{isInfoExpanded ? '24rpx' : '0'}}">
        <text class="card-title">订单信息</text>
        <view class="expand-btn">
          <text>{{isInfoExpanded ? '收起' : '展开'}}</text>
          <view class="arrow {{isInfoExpanded ? 'up' : 'down'}}"></view>
        </view>
      </view>

      <view class="info-row" style="margin-top: 24rpx;">
        <text class="info-label">订单编号</text>
        <view class="info-right" catchtap="copyOrderId">
          <text class="info-val">{{order.orderNo}}</text>
          <text class="copy-btn">复制</text>
        </view>
      </view>
      
      <view class="info-row" style="{{isInfoExpanded ? 'margin-bottom: 0;' : ''}}">
        <text class="info-label">下单时间</text>
        <text class="info-val">{{order.createdAtText}}</text>
      </view>

      <view class="info-fold-area" wx:if="{{isInfoExpanded}}">
        <view class="info-row" wx:if="{{order.pickupInfo.time}}">
          <text class="info-label">预约时间</text>
          <text class="info-val">{{order.pickupInfo.time}}</text>
        </view>
        
        <view class="info-row">
          <text class="info-label">支付方式</text>
          <text class="info-val">微信支付</text>
        </view>

        <view class="info-row" wx:if="{{order.remark}}">
          <text class="info-label">备注内容</text>
          <text class="info-val">{{order.remark}}</text>
        </view>
      </view>
    </view>
  </view>

  <view class="footer-spacer"></view>
  </scroll-view>
  <view class="footer-bar safe-area-bottom">
    <button class="btn btn-outline" bindtap="contactShop">联系客服</button>
    <button class="btn btn-outline" wx:if="{{order.refund && order.refund.status === 'applied'}}" bindtap="cancelRefund">取消售后</button>
    <button class="btn btn-outline" wx:if="{{order.refund}}" bindtap="goRefundDetail">售后详情</button>
    <button class="btn btn-black" wx:if="{{order.canApplyRefund}}" bindtap="openRefundSheet">申请售后</button>
  </view>

  <view class="mask" wx:if="{{refundSheetVisible}}" bindtap="closeRefundSheet"></view>
  <view class="sheet-modal safe-area-bottom" wx:if="{{refundSheetVisible}}">
    <view class="sheet-header">
      <text class="sheet-title">申请售后</text>
      <view class="close-btn" bindtap="closeRefundSheet">×</view>
    </view>
    <view class="sheet-body">
      <view class="sheet-label">请选择原因</view>
      <view class="reason-tags">
        <block wx:for="{{refundReasonList}}" wx:key="*this" wx:for-index="idx">
          <view class="tag {{refundReasonIndex===idx?'active':''}}" 
                data-index="{{idx}}" bindtap="chooseRefundReason">{{item}}</view>
        </block>
      </view>
      <textarea class="sheet-textarea" placeholder="请详细描述问题（选填）" 
                maxlength="200" bindinput="onRefundRemarkInput" value="{{refundRemark}}"></textarea>
    </view>
    <button class="sheet-confirm-btn" bindtap="submitRefund">提交申请</button>
  </view>
</view>