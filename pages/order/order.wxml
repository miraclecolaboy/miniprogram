<view class="page">

<!-- 顶部区域 -->
<view class="page-header">

  <!-- 顶部信息区（黑白极简） -->
  <view class="top-card llj-enter llj-delay-1">

    <view class="top-card-main">
      <view class="top-card-left">
        <view class="store-name {{storeName ? 'store-name--in' : ''}}">{{storeName}}</view>
      </view>
      <view class="top-card-right">
        <view
          class="mode-pill {{mode=='ziti'?'active':''}}"
          data-mode="ziti"
          bindtap="changeMode"
          hover-class="hover-scale-sm"
        >自提</view>
        <view
          class="mode-pill {{mode=='waimai'?'active':''}}"
          data-mode="waimai"
          bindtap="changeMode"
          wx:if="{{waimaiOn}}"
          hover-class="hover-scale-sm"
        >外卖</view>
        <view
          class="mode-pill {{mode=='kuaidi'?'active':''}}"
          data-mode="kuaidi"
          bindtap="changeMode"
          wx:if="{{kuaidiOn}}"
          hover-class="hover-scale-sm"
        >快递</view>
      </view>
    </view>

    <!-- 公告条 -->
    <view class="notice-bar" wx:if="{{notice}}">
      <view class="notice-icon">告</view>
      <view class="notice-marquee">{{notice}}</view>
    </view>

  </view>

</view>

<!-- 主体点单区域 -->
<view class="page-body llj-enter llj-delay-2">
  <view class="order-container">

    <!-- 左侧分类栏 -->
    <scroll-view class="categories" scroll-y enhanced="true" show-scrollbar="{{false}}">
      <block wx:for="{{categories}}" wx:key="id">
        <view
          class="category-item {{selectedCategoryId === item.id ? 'active' : ''}}"
          bindtap="selectCategory"
          data-id="{{item.id}}"
          hover-class="category-hover"
        >
          {{item.name}}
        </view>
      </block>
    </scroll-view>

    <!-- 右侧商品列表 -->
    <scroll-view class="products" scroll-y bindscrolltolower="onProductsReachBottom" lower-threshold="200" enhanced="true" show-scrollbar="{{false}}">
      <view wx:if="{{catalogLoading}}" class="sk-list">
        <view class="sk-title llj-shimmer"></view>
        <view class="sk-card" wx:for="{{skeletonList}}" wx:key="*this">
          <view class="sk-img llj-shimmer"></view>
          <view class="sk-content">
            <view class="sk-line sk-line-lg llj-shimmer"></view>
            <view class="sk-line sk-line-sm llj-shimmer"></view>
            <view class="sk-row">
              <view class="sk-price llj-shimmer"></view>
              <view class="sk-btn llj-shimmer"></view>
            </view>
          </view>
        </view>
      </view>

      <block wx:else>
        <view class="category-title" wx:if="{{selectedCategoryName}}">{{selectedCategoryName}}</view>
        <block wx:for="{{filteredProducts}}" wx:key="animKey">
          <view
            class="product-card llj-enter"
            style="animation-delay: {{item.animDelay}};"
            data-id="{{item.id}}"
            bindtap="goDetail"
            hover-class="product-hover"
          >
            <image class="product-img" src="{{item.img}}" mode="aspectFill" lazy-load="true" />

              <view class="product-content">
                <view class="product-title">{{item.name}}</view>
                <view class="product-desc" wx:if="{{item.desc}}">{{item.desc}}</view>

                <view class="product-bottom">
                  <view class="product-price"><text class="currency">￥</text>{{item.priceWithSpec || item.price}}</view>

                <!-- 右侧数量 / 选规格 -->
                <view class="product-qty">

                  <!-- 有规格：显示“选规格”按钮 -->
                  <view wx:if="{{item.hasSpecs}}" class="qty-control">
                    <view
                      class="spec-choose-btn"
                      catchtap="openSpecPopup"
                      data-id="{{item.id}}"
                      hover-class="btn-hover"
                      hover-stop-propagation="true"
                    >
                      选择
                    </view>
                  </view>

                  <!-- 无规格：显示 + - 数量 -->
                  <view wx:else class="qty-control">
                    <view wx:if="{{item.count > 0}}" class="qty-control">
                      <view class="qty-btn minus" catchtap="decreaseCount" data-id="{{item.id}}" hover-class="qty-hover" hover-stay-time="80" hover-stop-propagation="true">
                        <view class="icon-bar h"></view>
                      </view>
                      <text class="qty-count">{{item.count}}</text>
                      <view class="qty-btn plus" catchtap="addToCart" data-id="{{item.id}}" hover-class="qty-hover-dark" hover-stay-time="80" hover-stop-propagation="true">
                        <view class="icon-bar h"></view>
                        <view class="icon-bar v"></view>
                      </view>
                    </view>
                    <view wx:else class="qty-control">
                      <view class="qty-btn plus" catchtap="addToCart" data-id="{{item.id}}" hover-class="qty-hover-dark" hover-stay-time="80" hover-stop-propagation="true">
                        <view class="icon-bar h"></view>
                        <view class="icon-bar v"></view>
                      </view>
                    </view>
                  </view>

                </view>
              </view>
            </view>
          </view>
        </block>
      </block>
    </scroll-view>

  </view>
</view>

<!-- 规格选择弹窗遮罩 -->
<view
  wx:if="{{showSpecPopup}}"
  class="spec-mask"
  bindtap="closeSpecPopup"
></view>

<!-- 规格选择弹窗：新版布局 -->
<view wx:if="{{showSpecPopup}}" class="spec-popup" catchtap="noop">

  <view class="spec-header">
    <view class="spec-header-title">选择规格</view>
  </view>

  <!-- 顶部 商品图片 + 文案 -->
  <view class="spec-top">
    <image class="spec-top-img" src="{{specProduct.img}}" mode="aspectFill" lazy-load="true"></image>
    <view class="spec-top-info">
      <view class="spec-top-title">{{specProduct.name}}</view>
      <view class="spec-top-desc">{{specProduct.desc || '暂无描述'}}</view>
    </view>
  </view>

  <!-- 内容滚动 -->
  <scroll-view class="spec-scroll" scroll-y enhanced="true" show-scrollbar="{{false}}">

    <!-- 规格组 -->
    <block wx:for="{{specProduct.specs}}" wx:key="name">
      <view class="spec-group">
        <view class="spec-group-title">{{item.name}}</view>

        <view class="spec-options">
          <block wx:for="{{item.options}}" wx:for-item="opt" wx:key="label">
            <view
              class="spec-option {{specSelectedSpecs[item.name] === opt.label ? 'active' : ''}}"
              data-group="{{item.name}}"
              data-option="{{opt.label}}"
              bindtap="selectSpecOption"
              hover-class="spec-option-hover"
            >
              {{opt.label}}
            </view>
          </block>
        </view>
      </view>
    </block>

    <!-- 数量选择 -->
    <view class="spec-qty">
      <view class="spec-qty-label">数量</view>
      <view class="spec-qty-control">
        <view class="qty-btn minus" bindtap="decreaseSpecQty" hover-class="qty-hover" hover-stay-time="80" hover-stop-propagation="true">
          <view class="icon-bar h"></view>
        </view>
        <text class="qty-count">{{specQuantity}}</text>
        <view class="qty-btn plus" bindtap="increaseSpecQty" hover-class="qty-hover-dark" hover-stay-time="80" hover-stop-propagation="true">
          <view class="icon-bar h"></view>
          <view class="icon-bar v"></view>
        </view>
      </view>
    </view>

  </scroll-view>

  <!-- 底部金额栏 -->
  <view class="spec-bottom">
    <view class="spec-bottom-left">
      <view class="spec-bottom-label">合计</view>
      <view class="spec-bottom-price">￥{{specTotalPrice}}</view>
    </view>

    <button class="spec-bottom-btn" bindtap="confirmSpecAdd" hover-class="btn-hover-dark">
      加入购物车
    </button>
  </view>
</view>

<!-- 购物车遮罩 -->
<view wx:if="{{showCartDetailFlag}}" class="cart-mask" bindtap="closeCartDetail"></view>

<!-- 购物车详情弹层 -->
<view wx:if="{{showCartDetailFlag}}" class="cart-sheet">
  <view class="cart-sheet-header">
    <view class="cart-sheet-title">已选商品</view>
    <view class="cart-sheet-clear" bindtap="clearCart">清空</view>
  </view>

  <scroll-view class="cart-sheet-list" scroll-y enhanced="true" show-scrollbar="{{false}}">
    <block wx:for="{{cart}}" wx:key="cartKey">
      <view wx:if="{{item.count > 0}}" class="cart-item">
        <image class="cart-item-img" src="{{item.img}}" mode="aspectFill" lazy-load="true" />
        <view class="cart-item-content">
          <view class="cart-item-title">{{item.name}}</view>

          <!-- 规格 + 单价同一行（有规格时） -->
          <view wx:if="{{item.specText}}" class="cart-item-sub cart-item-sub-row">
            <text class="cart-item-spec">{{item.specText}}</text>
            <text class="cart-item-unit">单价 ￥{{item.price}}</text>
          </view>

          <!-- 无规格：单价独占一行 -->
          <view wx:else class="cart-item-sub">单价 ￥{{item.price}}</view>

          <view class="cart-item-bottom">
              <view class="cart-item-total">小计 ￥{{item.total}}</view>
            <view class="cart-item-qty">
              <view class="qty-btn minus" bindtap="decreaseCount" data-id="{{item.cartKey}}" hover-class="qty-hover" hover-stay-time="80" hover-stop-propagation="true">
                <view class="icon-bar h"></view>
              </view>
              <text class="qty-count">{{item.count}}</text>
              <view class="qty-btn plus" bindtap="increaseCartItemCount" data-id="{{item.cartKey}}" hover-class="qty-hover-dark" hover-stay-time="80" hover-stop-propagation="true">
                <view class="icon-bar h"></view>
                <view class="icon-bar v"></view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </block>
  </scroll-view>
</view>

<!-- 底部悬浮结算条 -->
<view class="cart-float llj-enter llj-delay-3">
  <view class="cart-bar">
    <view class="cart-bar-left" bindtap="showCartDetail" hover-class="hover-opacity">
      <view class="cart-bar-text">
        <view class="cart-total"><text class="currency">￥</text>{{totalPrice}}</view>
        <view class="cart-tip" wx:if="{{mode!='ziti' && totalCount>0 && needMoreFreeDelivery>0}}">还差￥{{needMoreFreeDelivery}}免配送费</view>
        <view class="cart-tip" wx:elif="{{totalCount>0}}">已选 {{totalCount}} 件</view>
        <view class="cart-tip" wx:else>请选择商品</view>
      </view>
    </view>

    <button class="cart-btn {{checkoutDisabled?'disabled':''}} {{checkoutActive?'active':''}}" catchtap="goToCart" hover-class="btn-hover-dark">
      {{checkoutBtnText}}
    </button>
  </view>
</view>

</view>
