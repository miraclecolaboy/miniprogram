<view class="page">
  <canvas 
    canvas-id="avatar-cropper" 
    id="avatar-cropper" 
    style="position: fixed; left: -9999px; top: -9999px; width: 300px; height: 300px;"
  ></canvas>

  <view class="header-hero">
    <view class="stars stars1"></view>
    <view class="stars stars2"></view>
    <view class="stars stars3"></view>
    <view class="hero-content">
      <view class="hero-user" bindtap="onTapUserCard">
        <view class="hero-avatar-wrap">
          <image wx:if="{{isLogin && userInfo.avatarUrl}}" class="hero-avatar-img" src="{{userInfo.avatarUrl}}" mode="aspectFill" />
          <text wx:else class="hero-avatar-text"></text>
        </view>
        <view class="hero-name">{{isLogin ? userInfo.nickName : '点击登录'}}</view>
        <view class="hero-sub">{{isLogin ? userInfo.userSub : '同步订单与会员权益'}}</view>
      </view>
      <view class="asset-strip">
        <view class="asset-strip-item" bindtap="onRecharge" hover-class="asset-hover">
          <view class="asset-strip-value">￥{{userInfo.balance || '0.00'}}</view>
          <view class="asset-strip-label">
            <text>余额</text>
            <text class="asset-arrow">›</text>
          </view>
        </view>
        <view class="asset-strip-divider"></view>
        <view class="asset-strip-item" bindtap="onPoints" hover-class="asset-hover">
          <view class="asset-strip-value">{{userInfo.points || 0}}</view>
          <view class="asset-strip-label">
            <text>积分</text>
            <text class="asset-arrow">›</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <view 
    class="card vip-card {{userInfo.memberActive ? 'vip-on' : 'vip-off'}}" 
    bindtap="onTapMember"
    style="height: {{vipCardHeight}}px;"
  >
    <view class="vip-bg">
      <view class="vip-circle c1"></view>
      <view class="vip-circle c2"></view>
    </view>
    <view class="vip-header">
      <view class="vip-status">{{userInfo.memberActive ? '等级会员' : '开通等级会员'}}</view>
      <view class="vip-entry">
        <text>Lv{{userInfo.memberLevel || 0}}</text>
        <text class="arrow">›</text>
      </view>
    </view>
    <view class="vip-footer">
      <view class="vip-benefit">{{userInfo.memberLevel >= 4 ? '全场下单享 9.5 折' : (userInfo.memberActive ? '升级送券，礼包仅发一次' : '充值升级送券')}}</view>
      <view wx:if="{{userInfo.memberActive}}" class="vip-expire">{{userInfo.memberTag}}</view>
    </view>
  </view>

  <view class="bottom-section">
    <view class="action-capsule">
      <view class="action-item" hover-class="item-hover-lift" bindtap="onTapOrder">
        <image class="action-icon" src="../../assets/orders.png"/>
        <text class="action-text">我的订单</text>
      </view>
      <view class="action-divider"></view>
      <view class="action-item" hover-class="item-hover-lift" bindtap="onTapCoupon">
        <image class="action-icon" src="../../assets/coupon.png"/>
        <text class="action-text">优惠券</text>
      </view>
      <view class="action-divider"></view>
      <view class="action-item" hover-class="item-hover-lift" bindtap="onTapAddress">
        <image class="action-icon" src="../../assets/address.png"/>
        <text class="action-text">我的地址</text>
      </view>
      <view class="action-divider"></view>
      <view class="action-item" hover-class="item-hover-lift" bindtap="onTapService">
        <image class="action-icon" src="../../assets/service.png"/>
        <text class="action-text">联系客服</text>
      </view>
    </view>
  </view>

  <view wx:if="{{showProfilePopup}}" class="spec-mask" bindtap="closeProfilePopup"></view>
  <view wx:if="{{showProfilePopup}}" class="spec-popup" catchtap="noop">
    <view class="spec-top">
      <view class="profile-avatar-wrap">
        <image wx:if="{{profileAvatarPreview}}" class="profile-avatar-img" src="{{profileAvatarPreview}}" mode="aspectFill" />
        <view wx:else class="profile-avatar-ph">头像</view>
        <button class="profile-avatar-btn" bindtap="onChangeAvatar"></button>
      </view>
      <view class="spec-top-info">
        <view class="spec-top-title">编辑资料</view>
        <view class="spec-top-sub">点击头像可更换</view>
      </view>
    </view>
    <view class="profile-body">
      <view class="profile-row">
        <text class="profile-label">昵称</text>
        <input class="profile-input" type="nickname" value="{{profileNickName}}" placeholder="请输入昵称" bindinput="onNickInput" />
      </view>
    </view>
    <view class="profile-bottom">
      <button class="profile-btn profile-btn-cancel" bindtap="closeProfilePopup">取消</button>
      <button class="profile-btn profile-btn-save" bindtap="onSaveProfile" loading="{{profileSaving}}" disabled="{{profileSaving}}">保存</button>
    </view>
  </view>
</view>
