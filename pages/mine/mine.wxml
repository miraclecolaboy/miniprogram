<view class="page">
  <scroll-view class="page-scroll" scroll-y="true" enhanced="true" show-scrollbar="{{false}}" refresher-enabled="true" refresher-triggered="{{refresherTriggered}}" bindrefresherrefresh="onRefresherRefresh">
  <view class="user-header center" bindtap="onTapUserCard">
    <view class="avatar-wrap">
      <image 
        class="user-avatar" 
        src="{{isLogin && userInfo.avatarUrl ? userInfo.avatarUrl : '/assets/mine.png'}}" 
        mode="aspectFill" 
      />
    </view>
    <view class="user-info">
      <view class="user-name">{{isLogin ? userInfo.nickName : '点击登录/注册'}}</view>
      <view class="user-sub">
        <text>{{isLogin ? userInfo.userSub : '登录同步订单与权益'}}</text>
        <text class="arrow">›</text>
      </view>
    </view>
  </view>

  <view class="vip-card-wrap">
    <view class="vip-card {{memberCardExpanded ? 'expanded' : ''}}" bindtap="toggleMemberCard">
      <view class="vip-texture"></view>
      
      <view class="vip-header">
        <view class="vip-info">
          <view class="vip-name">Lv.{{userInfo.memberLevel || 0}} 尊享会员</view>
          <view class="vip-tag" wx:if="{{(userInfo.memberLevel || 0) >= 4}}">下单95折</view>
        </view>
        <view class="vip-logo">VIP</view>
      </view>

      <view class="vip-expand">
        <view class="vip-progress-meta">
          <text>当前成长值 {{userInfo.totalRecharge || 0}}</text>
          <text wx:if="{{(userInfo.memberLevel || 0) < 4}}">Lv.{{(userInfo.memberLevel || 0) + 1}}</text>
        </view>
        <view class="vip-progress-track">
          <view class="vip-progress-fill" style="{{userInfo.progressStyle || 'width: 0%;'}}"></view>
        </view>
        <view class="vip-next-tip">{{userInfo.nextLevelText || '登录后查看会员成长值'}}</view>
        <view class="vip-actions">
          <view class="vip-action-btn" catchtap="onTapMemberDetail">查看权益</view>
        </view>
      </view>

      <view class="expand-indicator {{memberCardExpanded ? 'rotate' : ''}}">
        <text>⌄</text>
      </view>
    </view>
  </view>

  <view class="dashboard-section {{memberCardExpanded ? 'card-expanded' : ''}}">
    <view class="data-board">
      <view class="data-item" bindtap="onRecharge" hover-class="item-hover">
        <view class="data-num">{{userInfo.balance || '0.00'}}</view>
        <view class="data-label">余额</view>
      </view>
      <view class="data-divider"></view>
      <view class="data-item" bindtap="onPoints" hover-class="item-hover">
        <view class="data-num">{{userInfo.points || 0}}</view>
        <view class="data-label">积分</view>
      </view>
      <view class="data-divider"></view>
      <view class="data-item" bindtap="onTapCoupon" hover-class="item-hover">
        <view class="data-num" style="color: #BFA15F">{{userInfo.coupons || 0}}</view>
        <view class="data-label">优惠券</view>
      </view>
    </view>
  </view>

  <view class="menu-section">
    <view class="menu-list">
      <view class="menu-row" bindtap="onTapOrder" hover-class="item-hover-scale">
        <view class="menu-left">
          <view class="icon-wrap">
            <image class="menu-icon" src="/assets/orders.png" mode="aspectFit" />
          </view>
          <text class="menu-text">我的订单</text>
        </view>
        <text class="menu-arrow">›</text>
      </view>

      <view class="menu-divider"></view>

      <view class="menu-row" bindtap="onTapAddress" hover-class="item-hover-scale">
        <view class="menu-left">
          <view class="icon-wrap">
            <image class="menu-icon" src="/assets/location.png" mode="aspectFit" />
          </view>
          <text class="menu-text">收货地址</text>
        </view>
        <text class="menu-arrow">›</text>
      </view>

      <view class="menu-divider"></view>

      <view class="menu-row" bindtap="onTapService" hover-class="item-hover-scale">
        <view class="menu-left">
          <view class="icon-wrap">
            <image class="menu-icon" src="/assets/service.png" mode="aspectFit" />
          </view>
          <text class="menu-text">联系客服</text>
        </view>
        <text class="menu-arrow">›</text>
      </view>
    </view>
  </view>

  <view class="page-scroll-spacer"></view>
  </scroll-view>

  <view wx:if="{{showProfilePopup}}" class="spec-mask" bindtap="closeProfilePopup" catchtouchmove="noop"></view>
  
  <view wx:if="{{showProfilePopup}}" class="spec-popup" catchtap="noop" catchtouchmove="noop">
    <view class="pop-title">编辑个人资料</view>

    <view class="pop-avatar-center" bindtap="onChangeAvatar">
      <view class="pop-avatar-wrap">
        <image 
          class="pop-avatar-img" 
          src="{{profileAvatarPreview || '/assets/mine.png'}}" 
          mode="aspectFill" 
        />
        <view class="pop-avatar-badge">
          <view class="camera-shape">
            <view class="camera-lens"></view>
          </view>
        </view>
      </view>
    </view>

    <view class="pop-input-group">
      <text class="pop-label">昵称</text>
      <input 
        class="pop-input" 
        type="nickname" 
        value="{{profileNickName}}" 
        placeholder="请输入昵称" 
        placeholder-class="pop-input-ph"
        bindinput="onNickInput" 
        always-embed="{{true}}"
      />
    </view>

    <view class="pop-btn-group">
      <button class="pop-btn pop-btn-cancel" bindtap="closeProfilePopup">取消</button>
      <button 
        class="pop-btn pop-btn-save" 
        bindtap="onSaveProfile" 
        loading="{{profileSaving}}" 
        disabled="{{profileSaving}}"
      >保存</button>
    </view>
  </view>

  <canvas canvas-id="avatar-cropper" style="position: fixed; left: -9999px; top: -9999px; width: 300px; height: 300px;"></canvas>
</view>
